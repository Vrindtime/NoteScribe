name: Deploy Note‑Scribe

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # OIDC for AWS

    steps:
      # -------------------------------------------------
      # 1. Checkout code
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Set up Python 3.11
      # -------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # -------------------------------------------------
      # 3. Create clean deployment folder
      # -------------------------------------------------
      - name: Prepare deployment folder
        run: |
          mkdir -p deploy

      # -------------------------------------------------
      # 4. Install *all* pure‑Python deps (fastapi, mangum, etc.)
      # -------------------------------------------------
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt -t deploy \
          --platform manylinux2014_x86_64 \
          --only-binary=:all:

      # -------------------------------------------------
      # 5. Install **onnxruntime** built for Amazon Linux 2
      #     (manylinux2014 = glibc ≤ 2.26 → Lambda‑compatible)
      # -------------------------------------------------
      - name: Install onnxruntime (Lambda‑compatible)
        run: |
          pip install \
            onnxruntime==1.16.0 \
            --platform manylinux2014_x86_64 \
            --only-binary=:all: \
            --target deploy \
            --no-cache-dir
        
      - name: Enabling execute permissions for onnxruntime
        run: |
          chmod -R 755 deploy/onnxruntime/
          find deploy -type f -name "*.so" -exec chmod 755 {} \;

      # -------------------------------------------------
      # 6. Copy source files + JSON config
      # -------------------------------------------------
      - name: Copy application code
        run: |
          # cp app/main.py app/helper.py app/en_US-lessac-medium.onnx.json deploy/
          cp app/main.py deploy/

      # -------------------------------------------------
      # 7. Strip bloat (dist‑info, __pycache__, tests, .so.debug)
      # -------------------------------------------------
      - name: Clean up unnecessary files
        run: |
          cd deploy
          rm -rf ./*.dist-info */*.dist-info
          find . -type d -name "__pycache__" -exec rm -rf {} +
          find . -type f -name "*.pyc" -delete
          rm -rf */tests */*.so.debug

      # -------------------------------------------------
      # 8. Create final ZIP (max compression)
      # -------------------------------------------------
      - name: Create deployment package
        run: |
          cd deploy
          zip -r9 ../note-scribe-deploy.zip . > /dev/null
          cd ..
          echo "ZIP size:"
          ls -lh note-scribe-deploy.zip

      # -------------------------------------------------
      # 9. Configure AWS credentials via OIDC
      # -------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-south-1

      # -------------------------------------------------
      # 10. Upload ZIP to S3
      # -------------------------------------------------
      - name: Upload to S3
        run: |
          aws s3 cp note-scribe-deploy.zip s3://note-scribe/

      # -------------------------------------------------
      # 11. Update Lambda function
      # -------------------------------------------------
      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name note-scribe \
            --s3-bucket note-scribe \
            --s3-key note-scribe-deploy.zip \
            --publish