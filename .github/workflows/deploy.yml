name: ECR Build and Lambda Deployment

on:
  push:
    branches: [ main ]

env:
  # Define standard variables used across both jobs
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: note-scribe-tts
  LAMBDA_FUNCTION_NAME: note-scribe # Replace with your Lambda function name

jobs:
  # ======================================================
  # JOB 1: BUILD DOCKER IMAGE AND PUSH TO ECR
  # ======================================================
  build_and_push_ecr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    # Define outputs this job will pass to subsequent jobs
    outputs:
      image_uri: ${{ steps.image_uri_output.outputs.image_uri }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Build Job)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set Image Variables
        id: vars
        run: |
          # Use the ECR registry URI output from step 3
          echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_ENV
          # Tag the image with the short commit SHA
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          # Calculate the full image URI
          FULL_IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          echo "FULL_IMAGE_URI=$FULL_IMAGE_URI" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Tags the image with both the commit SHA and 'latest'
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }},${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      - name: Output ECR Image URI for next job
        id: image_uri_output
        run: |
          # Set the final output variable
          echo "image_uri=${{ env.FULL_IMAGE_URI }}" >> $GITHUB_OUTPUT

  # ======================================================
  # JOB 2: DEPLOY TO LAMBDA
  # ======================================================
  deploy_to_lambda:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    # This job MUST run only after the ECR push is complete
    needs: [build_and_push_ecr]

    steps:
      - name: Configure AWS credentials (Deploy Job)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get ECR Image URI from previous job
        run: |
          echo "IMAGE_TO_DEPLOY=${{ needs.build_and_push_ecr.outputs.image_uri }}" >> $GITHUB_ENV
          echo "Image URI received: ${{ needs.build_and_push_ecr.outputs.image_uri }}"

      - name: Update Lambda function code
        run: |
          aws lambda update-function-code \
            --function-name ${{ env.LAMBDA_FUNCTION_NAME }} \
            --image-uri ${{ env.IMAGE_TO_DEPLOY }}
          
          echo "Lambda function ${{ env.LAMBDA_FUNCTION_NAME }} updated successfully with image:"
          echo "${{ env.IMAGE_TO_DEPLOY }}"
