name: Note Scrible

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write   # for AWS OIDC

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---- 1. Install Python deps into root ----
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt -t .

      # ---- 2. Build clean ZIP (app + JSON + deps) ----
      - name: Create deployment package
        run: |
          mkdir -p deploy/app
          cp -r app/* deploy/app/
          cp en_US-lessac-medium.onnx.json deploy/app/
          cp -r *.py deploy/ 2>/dev/null || true
          cd deploy
          zip -r9 ../note-scribe-deploy.zip .
          cd ..
          ls -lh note-scribe-deploy.zip

      # ---- 3. Configure AWS credentials via OIDC ----
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::YOUR_ACCOUNT_ID:role/GitHubActionsLambdaRole
          aws-region: ap-south-1

      # ---- 4. Upload ZIP to S3 ----
      - name: Upload to S3
        run: |
          aws s3 cp note-scribe-deploy.zip s3://note-scribe-bucket/

      # ---- 5. Update Lambda function code ----
      - name: Update Lambda
        run: |
          aws lambda update-function-code \
            --function-name note-scribe \
            --s3-bucket note-scribe-bucket \
            --s3-key note-scribe-deploy.zip \
            --publish

      # ---- 6. (Optional) Invalidate CloudFront if you have one ----
      # - name: Invalidate CloudFront
      #   run: aws cloudfront create-invalidation --distribution-id XXX --paths "/*"