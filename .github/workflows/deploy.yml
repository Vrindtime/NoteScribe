name: ECR Build and Push

on:
  push:
    branches: [ main ]

env:
  # Define standard variables used across both jobs
  AWS_REGION: ap-south-1
  ECR_REPOSITORY: note-scribe-tts
  LAMBDA_FUNCTION_NAME: note-scribe
  
jobs:
  # ======================================================
  # JOB 1: BUILD DOCKER IMAGE AND PUSH TO ECR
  # ======================================================
  build_and_push_ecr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    # OUTPUTS section is only needed if you have a subsequent job
    # outputs:
    #   image_uri: ${{ steps.image_uri_output.outputs.image_uri }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (Build Job)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }} # ap-south-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set Image Variables
        id: vars
        run: |
          # Use the ECR registry URI output
          echo "ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}" >> $GITHUB_ENV
          # Tag the image with the short commit SHA
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          # Calculate the full image URI
          FULL_IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
          echo "FULL_IMAGE_URI=$FULL_IMAGE_URI" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # OPTIONAL: Add platform if using ARM64 Lambda
          platforms: linux/arm64
          # Tags the image with both the commit SHA and 'latest'
          tags: ${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:${{ env.IMAGE_TAG }},${{ env.ECR_REGISTRY }}/${{ env.ECR_REPOSITORY }}:latest

      # Removed the image_uri_output step as it's not needed without the second job.