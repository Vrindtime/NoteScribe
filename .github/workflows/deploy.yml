name: Deploy Note-Scribe

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # -------------------------------------------------
      # 1. Checkout code
      # -------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2. Build package in AWS Lambda Docker (Python 3.11)
      # -------------------------------------------------
      - name: Build Lambda package in Docker
        run: |
          mkdir -p deploy

          docker run --rm \
            -v "$PWD":/var/task \
            -w /var/task \
            public.ecr.aws/lambda/python:3.11 \
            bash -c "
              # Upgrade pip
              pip install --upgrade pip

              # Install pure-Python deps from requirements.txt
              if [ -f requirements.txt ]; then
                pip install -r requirements.txt -t deploy/
              fi

              # Install onnxruntime (CPU, Lambda-compatible)
              pip install onnxruntime==1.16.0 -t deploy/

              # Copy application code
              cp app/main.py deploy/
            "

      # -------------------------------------------------
      # 3. Fix permissions on .so files (optional but safe)
      # -------------------------------------------------
      - name: Fix .so permissions
        run: |
          find deploy -name "*.so" -exec chmod 755 {} \;

      # -------------------------------------------------
      # 4. Clean up bloat
      # -------------------------------------------------
      - name: Clean up
        run: |
          cd deploy
          rm -rf ./*.dist-info */*.dist-info
          find . -type d -name "__pycache__" -exec rm -rf {} +
          find . -type f -name "*.pyc" -delete
          find . -name "tests" -exec rm -rf {} +
          rm -rf */boto* */botocore */s3transfer 2>/dev/null || true

      # -------------------------------------------------
      # 5. Create ZIP
      # -------------------------------------------------
      - name: Create deployment package
        run: |
          cd deploy
          zip -r9 ../note-scribe-deploy.zip . > /dev/null
          echo "ZIP size:"
          ls -lh ../note-scribe-deploy.zip

      # -------------------------------------------------
      # 6. Configure AWS credentials
      # -------------------------------------------------
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ap-south-1

      # -------------------------------------------------
      # 7. Upload to S3
      # -------------------------------------------------
      - name: Upload to S3
        run: |
          aws s3 cp note-scribe-deploy.zip s3://note-scribe/

      # -------------------------------------------------
      # 8. Update Lambda
      # -------------------------------------------------
      - name: Update Lambda function
        run: |
          aws lambda update-function-code \
            --function-name note-scribe \
            --s3-bucket note-scribe \
            --s3-key note-scribe-deploy.zip \
            --publish